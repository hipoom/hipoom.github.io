<!DOCTYPE html>
<html class="theme theme-white">
<head>
<meta charset="utf-8">
<title>Android Binder Hook的实现</title>
<link href="https://www.zybuluo.com/static/assets/template-theme-white.css" rel="stylesheet" media="screen">
<style type="text/css">

#wmd-preview h1  {
    color: #0077bb; /* 将标题改为蓝色 */
}</style>
</head>
<body class="theme theme-white">
<div id="wmd-preview" class="wmd-preview wmd-preview-full-reader"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="57np" id="android-binder-hook的实现">Android Binder Hook的实现</h1><p data-anchor-id="y2ha"><code>Android</code> <code>已发布的博客</code></p><hr><p data-anchor-id="5tfe"><div class="toc">
<ul>
<li><a href="#android-binder-hook的实现">Android Binder Hook的实现</a><ul>
<li><a href="#1-简述">1. 简述</a></li>
<li><a href="#2-context-获取系统-service-的流程">2. Context 获取系统 Service 的流程</a></li>
<li><a href="#3-创建自定义的service和binder">3 创建自定义的Service和Binder</a><ul>
<li><a href="#31-自定义的service对象">3.1 自定义的Service对象</a></li>
<li><a href="#32-自定义的binder对象">3.2 自定义的Binder对象</a></li>
</ul>
</li>
<li><a href="#4-将自定义的binder注入到servicemanager中">4. 将自定义的Binder注入到ServiceManager中</a></li>
<li><a href="#5-测试">5. 测试</a></li>
</ul>
</li>
</ul>
</div>
</p><hr><div class="md-section-divider"></div><h2 data-anchor-id="phkb" id="1-简述">1. 简述</h2><p data-anchor-id="6wt3">Binder Hook可以Hook掉<strong>当前App</strong>用到的系统Service服务。 <br>
以LocationManager为例，在获取一个LocationManager时分为两步。第一，获取IBinder对象；第二：IBinder对象通过asInterface()转化为LocationMangerService对象。最后初始化LocationManager，application层用到的都是LocationManager。 <br>
Hook的大致原理是：ServiceManager在获取某个Binder时，如果本地有缓存的Binder，就不再跨进程请求Binder了。我们可以在缓存中加入自己的Binder，使得ServiceManager查询本地缓存时得到一个自定义的CustomBinder对象，不再跨进程向系统请求。并且ILocationManager.Stub.asInterface(CustomBinder)方法返回我们自定义的Service对象。 <br>
这里面有两个地方需要用到自定义的对象。由于我们只Hook其中一部分的功能，其他功能还需要保留，所以用动态代理的方式创建自定义的Binder和自定义的Service。</p><p data-anchor-id="o670">在理解后面的内容前你需要了解这些知识点： <br>
1. 一点点Binder的知识，知道IBinder转IInterface的大致流程； <br>
2. Java的动态代理。</p><div class="md-section-divider"></div><h2 data-anchor-id="maud" id="2-context-获取系统-service-的流程">2. Context 获取系统 Service 的流程</h2><p data-anchor-id="tuh6">Activity等类在获取系统Service时，都是调用getSystemService(serviceName)方法获取的。</p><div class="md-section-divider"></div><div class="sequence-diagram theme theme-white" title="点击查看大图" data-anchor-id="iajg"><svg height="316" version="1.1" width="995" xmlns="http://www.w3.org/2000/svg" style="overflow: hidden; position: relative;"><desc style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Created with Raphaël 2.1.2</desc><defs style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block-obj1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path><marker id="raphael-marker-endblock55-obj2" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#raphael-marker-block-obj1" transform="rotate(180 2.5 2.5) scale(1,1)" stroke-width="1.0000" fill="#000" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker></defs><rect x="10" y="10" width="272" height="28" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="15" y="15" width="262" height="18" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="146" y="24" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: 'Andale Mono', monospace;" font-size="16px" font-family="Andale Mono, monospace"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Context 获取系统Service的流程</tspan></text><rect x="10" y="48" width="90" height="38" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="20" y="58" width="70" height="18" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="55" y="67" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: 'Andale Mono', monospace;" font-size="16px" font-family="Andale Mono, monospace"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Context</tspan></text><rect x="10" y="258" width="90" height="38" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="20" y="268" width="70" height="18" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="55" y="277" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: 'Andale Mono', monospace;" font-size="16px" font-family="Andale Mono, monospace"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Context</tspan></text><path fill="none" stroke="#000000" d="M55,86L55,258" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path><rect x="180" y="48" width="230" height="38" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="190" y="58" width="210" height="18" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="295" y="67" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: 'Andale Mono', monospace;" font-size="16px" font-family="Andale Mono, monospace"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">SystemServiceRegistry</tspan></text><rect x="180" y="258" width="230" height="38" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="190" y="268" width="210" height="18" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="295" y="277" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: 'Andale Mono', monospace;" font-size="16px" font-family="Andale Mono, monospace"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">SystemServiceRegistry</tspan></text><path fill="none" stroke="#000000" d="M295,86L295,258" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path><rect x="455" y="48" width="160" height="38" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="465" y="58" width="140" height="18" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="535" y="67" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: 'Andale Mono', monospace;" font-size="16px" font-family="Andale Mono, monospace"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">ServiceFetcher</tspan></text><rect x="455" y="258" width="160" height="38" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="465" y="268" width="140" height="18" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="535" y="277" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: 'Andale Mono', monospace;" font-size="16px" font-family="Andale Mono, monospace"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">ServiceFetcher</tspan></text><path fill="none" stroke="#000000" d="M535,86L535,258" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path><rect x="665" y="48" width="160" height="38" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="675" y="58" width="140" height="18" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="745" y="67" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: 'Andale Mono', monospace;" font-size="16px" font-family="Andale Mono, monospace"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">ServiceManager</tspan></text><rect x="665" y="258" width="160" height="38" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="675" y="268" width="140" height="18" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="745" y="277" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: 'Andale Mono', monospace;" font-size="16px" font-family="Andale Mono, monospace"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">ServiceManager</tspan></text><path fill="none" stroke="#000000" d="M745,86L745,258" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path><rect x="885" y="48" width="80" height="38" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="895" y="58" width="60" height="18" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="925" y="67" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: 'Andale Mono', monospace;" font-size="16px" font-family="Andale Mono, monospace"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">return</tspan></text><rect x="885" y="258" width="80" height="38" r="0" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="895" y="268" width="60" height="18" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="925" y="277" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: 'Andale Mono', monospace;" font-size="16px" font-family="Andale Mono, monospace"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">return</tspan></text><path fill="none" stroke="#000000" d="M925,86L925,258" stroke-width="2" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path><rect x="65" y="102" width="220" height="18" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="175" y="111" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: 'Andale Mono', monospace;" font-size="16px" font-family="Andale Mono, monospace"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">getSystemService(name)</tspan></text><path fill="none" stroke="#000000" d="M55,124C55,124,255.57602286338806,124,290.001058037451,124" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj2)" stroke-dasharray="0" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path><rect x="305" y="140" width="220" height="18" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="415" y="149" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: 'Andale Mono', monospace;" font-size="16px" font-family="Andale Mono, monospace"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">getSystemService(name)</tspan></text><path fill="none" stroke="#000000" d="M295,162C295,162,495.57602286338806,162,530.001058037451,162" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj2)" stroke-dasharray="0" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path><rect x="545" y="178" width="190" height="18" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="640" y="187" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: 'Andale Mono', monospace;" font-size="16px" font-family="Andale Mono, monospace"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">getService(contetx)</tspan></text><path fill="none" stroke="#000000" d="M535,200C535,200,708.1217986345291,200,739.9904109808267,200" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj2)" stroke-dasharray="0" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path><rect x="755" y="216" width="160" height="18" r="0" rx="0" ry="0" fill="#ffffff" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="835" y="225" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: 'Andale Mono', monospace;" font-size="16px" font-family="Andale Mono, monospace"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">getService(name)</tspan></text><path fill="none" stroke="#000000" d="M745,238C745,238,890.9265899658203,238,919.9979028105736,238" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj2)" stroke-dasharray="0" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path></svg></div><p data-anchor-id="wa4x">Context 的 getSystemService() 方法调用了 SystemServiceRegistry 的 getSystemService() 方法。 <br>
SystemServiceRegistry 中有一个常量 SYSTEM_SERVICE_FETCHERS，这是一个Map。保存了ServiceName和对应的ServiceFetcher。ServicFetcher是用于创建具体Service的类。ServiceFetcher 的关键方法是 createService() 方法。 <br>
在 ServiceFetcher 的 createService() 方法中，调用了 <code>ServiceManager.getService(name)</code>方法。以 LocationManager 对应的 ServiceFetcher 为例，它的createService()方法源码如下：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="2nsi"><ol class="linenums"><li class="L0"><code class="language-java"><span class="lit">@Override</span></code></li><li class="L1"><code class="language-java"><span class="kwd">public</span><span class="pln"> </span><span class="typ">LocationManager</span><span class="pln"> createService</span><span class="pun">(</span><span class="typ">ContextImpl</span><span class="pln"> ctx</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="language-java"><span class="pln">    </span><span class="typ">IBinder</span><span class="pln"> b </span><span class="pun">=</span><span class="pln"> </span><span class="typ">ServiceManager</span><span class="pun">.</span><span class="pln">getService</span><span class="pun">(</span><span class="str">"location"</span><span class="pun">);</span></code></li><li class="L3"><code class="language-java"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">LocationManager</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">,</span><span class="pln"> </span><span class="typ">ILocationManager</span><span class="pun">.</span><span class="typ">Stub</span><span class="pun">.</span><span class="pln">asInterface</span><span class="pun">(</span><span class="pln">b</span><span class="pun">));</span></code></li><li class="L4"><code class="language-java"><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="7bjx">假如我们要修改 LocationManager 的 getLastKnownLocation() 方法（下文都是）。我们要做的就是让ServiceManager.getService("location")返回我们自定义的Binder。先看一下这个方法简化后的源码：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="m8w8"><ol class="linenums"><li class="L0"><code class="language-java"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="typ">IBinder</span><span class="pln"> getService</span><span class="pun">(</span><span class="typ">String</span><span class="pln"> name</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code class="language-java"><span class="pln">    </span><span class="typ">IBinder</span><span class="pln"> service </span><span class="pun">=</span><span class="pln"> sCache</span><span class="pun">.</span><span class="pln">get</span><span class="pun">(</span><span class="pln">name</span><span class="pun">);</span></code></li><li class="L2"><code class="language-java"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">service </span><span class="pun">!=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code class="language-java"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> service</span><span class="pun">;</span></code></li><li class="L4"><code class="language-java"><span class="pln">    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code class="language-java"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> getIServiceManager</span><span class="pun">().</span><span class="pln">getService</span><span class="pun">(</span><span class="pln">name</span><span class="pun">);</span></code></li><li class="L6"><code class="language-java"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L7"><code class="language-java"><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="k7lz">sCache是一个Map，缓存了已经向系统请求过的Binder。如果我们需要让这个方法返回我们我们自己的binder，只需要事先往sCache中put一个自定义的Binder就行了。 <br>
在put之前，需要先创建出一个自定义的Binder。这个Binder在被 ILocationManager.Stub.asInterface 处理后，可以返回一个自定义的 LocationManagerService。 <br>
先看一下Binder的 asInterface() 的实现：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="u148"><ol class="linenums"><li class="L0"><code class="language-java"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">location</span><span class="pun">.</span><span class="typ">ILocationManager</span><span class="pln"> asInterface</span><span class="pun">(</span><span class="pln">android</span><span class="pun">.</span><span class="pln">os</span><span class="pun">.</span><span class="typ">IBinder</span><span class="pln"> obj</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code class="language-java"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">obj </span><span class="pun">==</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="language-java"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span></code></li><li class="L3"><code class="language-java"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L4"><code class="language-java"><span class="pln">    android</span><span class="pun">.</span><span class="pln">os</span><span class="pun">.</span><span class="typ">IInterface</span><span class="pln"> iin </span><span class="pun">=</span><span class="pln"> obj</span><span class="pun">.</span><span class="pln">queryLocalInterface</span><span class="pun">(</span><span class="pln">DESCRIPTOR</span><span class="pun">);</span></code></li><li class="L5"><code class="language-java"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(((</span><span class="pln">iin </span><span class="pun">!=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">(</span><span class="pln">iin </span><span class="kwd">instanceof</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">location</span><span class="pun">.</span><span class="typ">ILocationManager</span><span class="pun">)))</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code class="language-java"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">((</span><span class="pln">android</span><span class="pun">.</span><span class="pln">location</span><span class="pun">.</span><span class="typ">ILocationManager</span><span class="pun">)</span><span class="pln"> iin</span><span class="pun">);</span></code></li><li class="L7"><code class="language-java"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L8"><code class="language-java"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">location</span><span class="pun">.</span><span class="typ">ILocationManager</span><span class="pun">.</span><span class="typ">Stub</span><span class="pun">.</span><span class="typ">Proxy</span><span class="pun">(</span><span class="pln">obj</span><span class="pun">);</span></code></li><li class="L9"><code class="language-java"><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="cqhb">如果把 queryLocalInterface()方法返回一个自定义的Service，使得走if语句内部，不走else，那就算是Hook成功了。</p><blockquote data-anchor-id="00ej" class="white-blockquote">
  <p><strong>误区：</strong> <del>asInterface(binder) 就是把 binder 做了一次类型转换</del> <br>
  实际上<code>XXX service = XXX.Stub.asInterface(binder)</code>的返回值根据 binder 的来源有两种情况： <br>
  1. <strong>跨进程</strong>时，service 的类型是 Test.Stub.Proxy <br>
  2. <strong>相同进程</strong>时，service 的类型是 Test.Stub <br>
  <strong>X.Stub.asInterface(binder);得到的返回值并不一定是binder自己</strong>，并且调用系统服务时肯定不是binder自己。</p>
</blockquote><hr><div class="md-section-divider"></div><h2 data-anchor-id="rh3g" id="3-创建自定义的service和binder">3 创建自定义的Service和Binder</h2><div class="md-section-divider"></div><h3 data-anchor-id="e3b4" id="31-自定义的service对象">3.1 自定义的Service对象</h3><p data-anchor-id="89sp">假设我们想让系统的LocationManager返回的位置信息全是在天安门(116.23, 39.54)。那我们需要使得 LocatitionManagerService 的 getLastLocation() 方法 返回的全是 (116.23, 39.54)。 <br>
由于我们不能直接拿到系统的这个Service对象，可以先用反射的方式拿到系统的LocationManagerService。然后拦截getLastLocation()方法。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="16da"><ol class="linenums"><li class="L0"><code class="language-java"><span class="kwd">package</span><span class="pln"> com</span><span class="pun">.</span><span class="pln">zhp</span><span class="pun">.</span><span class="pln">binderhook</span><span class="pun">;</span></code></li><li class="L1"><code class="language-java"></code></li><li class="L2"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">location</span><span class="pun">.</span><span class="typ">Location</span><span class="pun">;</span></code></li><li class="L3"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">location</span><span class="pun">.</span><span class="typ">LocationManager</span><span class="pun">;</span></code></li><li class="L4"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">os</span><span class="pun">.</span><span class="typ">IBinder</span><span class="pun">;</span></code></li><li class="L5"><code class="language-java"></code></li><li class="L6"><code class="language-java"><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">lang</span><span class="pun">.</span><span class="pln">reflect</span><span class="pun">.</span><span class="typ">InvocationHandler</span><span class="pun">;</span></code></li><li class="L7"><code class="language-java"><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">lang</span><span class="pun">.</span><span class="pln">reflect</span><span class="pun">.</span><span class="typ">Method</span><span class="pun">;</span></code></li><li class="L8"><code class="language-java"></code></li><li class="L9"><code class="language-java"><span class="com">/**</span></code></li><li class="L0"><code class="language-java"><span class="com"> * 动态代理时用到的Handler</span></code></li><li class="L1"><code class="language-java"><span class="com"> * @author ZHP</span></code></li><li class="L2"><code class="language-java"><span class="com"> * @since 16/12/25 17:36</span></code></li><li class="L3"><code class="language-java"><span class="com"> */</span></code></li><li class="L4"><code class="language-java"></code></li><li class="L5"><code class="language-java"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">ServiceHookHandler</span><span class="pln"> </span><span class="kwd">implements</span><span class="pln"> </span><span class="typ">InvocationHandler</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code class="language-java"></code></li><li class="L7"><code class="language-java"><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">Object</span><span class="pln"> mOriginService</span><span class="pun">;</span></code></li><li class="L8"><code class="language-java"></code></li><li class="L9"><code class="language-java"><span class="pln">    </span><span class="com">/**</span></code></li><li class="L0"><code class="language-java"><span class="com">     * @param binder 系统原始的Binder对象</span></code></li><li class="L1"><code class="language-java"><span class="com">     */</span></code></li><li class="L2"><code class="language-java"><span class="pln">    </span><span class="lit">@SuppressWarnings</span><span class="pun">(</span><span class="str">"unchecked"</span><span class="pun">)</span></code></li><li class="L3"><code class="language-java"><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="typ">ServiceHookHandler</span><span class="pun">(</span><span class="typ">IBinder</span><span class="pln"> binder</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L4"><code class="language-java"><span class="pln">        </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code class="language-java"><span class="pln">            </span><span class="com">// 由于可以拿到Binder对象,但无法拿到Service的对象,所以我们要手动获取</span></code></li><li class="L6"><code class="language-java"><span class="pln">            </span><span class="com">// 即: this.mOriginService = ILocationManager.Stub.asInterface(binder);</span></code></li><li class="L7"><code class="language-java"><span class="pln">            </span><span class="typ">Class</span><span class="pln"> </span><span class="typ">ILocationManager$Stub</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Class</span><span class="pun">.</span><span class="pln">forName</span><span class="pun">(</span><span class="str">"android.location.ILocationManager$Stub"</span><span class="pun">);</span></code></li><li class="L8"><code class="language-java"><span class="pln">            </span><span class="typ">Method</span><span class="pln"> asInterface </span><span class="pun">=</span><span class="pln"> </span><span class="typ">ILocationManager$Stub</span><span class="pun">.</span><span class="pln">getDeclaredMethod</span><span class="pun">(</span><span class="str">"asInterface"</span><span class="pun">,</span><span class="pln"> </span><span class="typ">IBinder</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span></code></li><li class="L9"><code class="language-java"><span class="pln">            </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">mOriginService </span><span class="pun">=</span><span class="pln"> asInterface</span><span class="pun">.</span><span class="pln">invoke</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> binder</span><span class="pun">);</span></code></li><li class="L0"><code class="language-java"><span class="pln">        </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Exception</span><span class="pln"> e</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code class="language-java"><span class="pln">            e</span><span class="pun">.</span><span class="pln">printStackTrace</span><span class="pun">();</span></code></li><li class="L2"><code class="language-java"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L3"><code class="language-java"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L4"><code class="language-java"></code></li><li class="L5"><code class="language-java"></code></li><li class="L6"><code class="language-java"></code></li><li class="L7"><code class="language-java"><span class="pln">    </span><span class="lit">@Override</span></code></li><li class="L8"><code class="language-java"><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="typ">Object</span><span class="pln"> invoke</span><span class="pun">(</span><span class="typ">Object</span><span class="pln"> proxy</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Method</span><span class="pln"> method</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">throws</span><span class="pln"> </span><span class="typ">Throwable</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code class="language-java"><span class="pln">        </span><span class="kwd">switch</span><span class="pun">(</span><span class="pln">method</span><span class="pun">.</span><span class="pln">getName</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L0"><code class="language-java"><span class="pln">            </span><span class="kwd">case</span><span class="pln"> </span><span class="str">"getLastLocation"</span><span class="pun">:</span></code></li><li class="L1"><code class="language-java"><span class="pln">                </span><span class="com">// 一直返回天安门的坐标</span></code></li><li class="L2"><code class="language-java"><span class="pln">                </span><span class="typ">Location</span><span class="pln"> location </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Location</span><span class="pun">(</span><span class="typ">LocationManager</span><span class="pun">.</span><span class="pln">GPS_PROVIDER</span><span class="pun">);</span></code></li><li class="L3"><code class="language-java"><span class="pln">                location</span><span class="pun">.</span><span class="pln">setLongitude</span><span class="pun">(</span><span class="lit">116.23</span><span class="pun">);</span></code></li><li class="L4"><code class="language-java"><span class="pln">                location</span><span class="pun">.</span><span class="pln">setLatitude</span><span class="pun">(</span><span class="lit">39.54</span><span class="pun">);</span></code></li><li class="L5"><code class="language-java"><span class="pln">                </span><span class="kwd">return</span><span class="pln"> location</span><span class="pun">;</span></code></li><li class="L6"><code class="language-java"></code></li><li class="L7"><code class="language-java"><span class="pln">            </span><span class="kwd">default</span><span class="pun">:</span></code></li><li class="L8"><code class="language-java"><span class="pln">                </span><span class="kwd">return</span><span class="pln"> method</span><span class="pun">.</span><span class="pln">invoke</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">mOriginService</span><span class="pun">,</span><span class="pln"> args</span><span class="pun">);</span></code></li><li class="L9"><code class="language-java"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L0"><code class="language-java"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L1"><code class="language-java"><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="ljzq" id="32-自定义的binder对象">3.2 自定义的Binder对象</h3><p data-anchor-id="3xlu">原生的Binder对象在调用 queryLocalInterface() 方法时会返回原生的Service对象。我们希望返回3.1中的自定义Service。所以这里拦截 queryLocalInterface() 方法。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="gyak"><ol class="linenums"><li class="L0"><code class="language-java"><span class="kwd">package</span><span class="pln"> com</span><span class="pun">.</span><span class="pln">zhp</span><span class="pun">.</span><span class="pln">binderhook</span><span class="pun">;</span></code></li><li class="L1"><code class="language-java"></code></li><li class="L2"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">os</span><span class="pun">.</span><span class="typ">IBinder</span><span class="pun">;</span></code></li><li class="L3"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">os</span><span class="pun">.</span><span class="typ">IInterface</span><span class="pun">;</span></code></li><li class="L4"><code class="language-java"></code></li><li class="L5"><code class="language-java"><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">lang</span><span class="pun">.</span><span class="pln">reflect</span><span class="pun">.</span><span class="typ">InvocationHandler</span><span class="pun">;</span></code></li><li class="L6"><code class="language-java"><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">lang</span><span class="pun">.</span><span class="pln">reflect</span><span class="pun">.</span><span class="typ">Method</span><span class="pun">;</span></code></li><li class="L7"><code class="language-java"><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">lang</span><span class="pun">.</span><span class="pln">reflect</span><span class="pun">.</span><span class="typ">Proxy</span><span class="pun">;</span></code></li><li class="L8"><code class="language-java"></code></li><li class="L9"><code class="language-java"><span class="com">/**</span></code></li><li class="L0"><code class="language-java"><span class="com"> * 动态代理时用到的Handler,用于创建自定义Binder</span></code></li><li class="L1"><code class="language-java"><span class="com"> * @author ZHP</span></code></li><li class="L2"><code class="language-java"><span class="com"> * @since 16/12/25 17:36</span></code></li><li class="L3"><code class="language-java"><span class="com"> */</span></code></li><li class="L4"><code class="language-java"></code></li><li class="L5"><code class="language-java"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">BinderHookHandler</span><span class="pln"> </span><span class="kwd">implements</span><span class="pln"> </span><span class="typ">InvocationHandler</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code class="language-java"></code></li><li class="L7"><code class="language-java"><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">IBinder</span><span class="pln"> mOriginBinder</span><span class="pun">;</span></code></li><li class="L8"><code class="language-java"></code></li><li class="L9"><code class="language-java"><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">Class</span><span class="pln"> </span><span class="typ">ILocationManager</span><span class="pun">;</span></code></li><li class="L0"><code class="language-java"></code></li><li class="L1"><code class="language-java"><span class="pln">    </span><span class="lit">@SuppressWarnings</span><span class="pun">(</span><span class="str">"unchecked"</span><span class="pun">)</span></code></li><li class="L2"><code class="language-java"><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="typ">BinderHookHandler</span><span class="pun">(</span><span class="typ">IBinder</span><span class="pln"> binder</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code class="language-java"><span class="pln">        </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">mOriginBinder </span><span class="pun">=</span><span class="pln"> binder</span><span class="pun">;</span></code></li><li class="L4"><code class="language-java"><span class="pln">        </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code class="language-java"><span class="pln">            </span><span class="kwd">this</span><span class="pun">.</span><span class="typ">ILocationManager</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Class</span><span class="pun">.</span><span class="pln">forName</span><span class="pun">(</span><span class="str">"android.location.ILocationManager"</span><span class="pun">);</span></code></li><li class="L6"><code class="language-java"><span class="pln">        </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">ClassNotFoundException</span><span class="pln"> e</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code class="language-java"><span class="pln">            e</span><span class="pun">.</span><span class="pln">printStackTrace</span><span class="pun">();</span></code></li><li class="L8"><code class="language-java"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L9"><code class="language-java"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L0"><code class="language-java"></code></li><li class="L1"><code class="language-java"><span class="pln">    </span><span class="lit">@Override</span></code></li><li class="L2"><code class="language-java"><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="typ">Object</span><span class="pln"> invoke</span><span class="pun">(</span><span class="typ">Object</span><span class="pln"> proxy</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Method</span><span class="pln"> method</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">throws</span><span class="pln"> </span><span class="typ">Throwable</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code class="language-java"><span class="pln">        </span><span class="kwd">switch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">method</span><span class="pun">.</span><span class="pln">getName</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L4"><code class="language-java"><span class="pln">            </span><span class="com">// 使得返回自定义的Service</span></code></li><li class="L5"><code class="language-java"><span class="pln">            </span><span class="kwd">case</span><span class="pln"> </span><span class="str">"queryLocalInterface"</span><span class="pun">:</span></code></li><li class="L6"><code class="language-java"><span class="pln">                </span><span class="typ">ClassLoader</span><span class="pln"> classLoader </span><span class="pun">=</span><span class="pln"> mOriginBinder</span><span class="pun">.</span><span class="pln">getClass</span><span class="pun">().</span><span class="pln">getClassLoader</span><span class="pun">();</span></code></li><li class="L7"><code class="language-java"><span class="pln">                </span><span class="typ">Class</span><span class="pun">[]</span><span class="pln"> interfaces </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Class</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">{</span><span class="typ">IInterface</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">,</span><span class="pln"> </span><span class="typ">IBinder</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">,</span><span class="pln"> </span><span class="typ">ILocationManager</span><span class="pun">};</span></code></li><li class="L8"><code class="language-java"><span class="pln">                </span><span class="typ">ServiceHookHandler</span><span class="pln"> handler </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ServiceHookHandler</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">mOriginBinder</span><span class="pun">);</span></code></li><li class="L9"><code class="language-java"><span class="pln">                </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Proxy</span><span class="pun">.</span><span class="pln">newProxyInstance</span><span class="pun">(</span><span class="pln">classLoader</span><span class="pun">,</span><span class="pln"> interfaces</span><span class="pun">,</span><span class="pln"> handler</span><span class="pun">);</span></code></li><li class="L0"><code class="language-java"></code></li><li class="L1"><code class="language-java"><span class="pln">            </span><span class="kwd">default</span><span class="pun">:</span></code></li><li class="L2"><code class="language-java"><span class="pln">                </span><span class="kwd">return</span><span class="pln"> method</span><span class="pun">.</span><span class="pln">invoke</span><span class="pun">(</span><span class="pln">mOriginBinder</span><span class="pun">,</span><span class="pln"> args</span><span class="pun">);</span></code></li><li class="L3"><code class="language-java"></code></li><li class="L4"><code class="language-java"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L5"><code class="language-java"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L6"><code class="language-java"><span class="pun">}</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h2 data-anchor-id="1p2l" id="4-将自定义的binder注入到servicemanager中">4. 将自定义的Binder注入到ServiceManager中</h2><p data-anchor-id="if94">有了自定义的Binder后，将它注入到ServiceManger的sCache变量中就完成Hook了~</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="e87m"><ol class="linenums"><li class="L0"><code class="language-java"><span class="kwd">package</span><span class="pln"> com</span><span class="pun">.</span><span class="pln">zhp</span><span class="pun">.</span><span class="pln">binderhook</span><span class="pun">;</span></code></li><li class="L1"><code class="language-java"></code></li><li class="L2"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">content</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">;</span></code></li><li class="L3"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">os</span><span class="pun">.</span><span class="typ">IBinder</span><span class="pun">;</span></code></li><li class="L4"><code class="language-java"></code></li><li class="L5"><code class="language-java"><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">lang</span><span class="pun">.</span><span class="pln">reflect</span><span class="pun">.</span><span class="typ">Field</span><span class="pun">;</span></code></li><li class="L6"><code class="language-java"><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">lang</span><span class="pun">.</span><span class="pln">reflect</span><span class="pun">.</span><span class="typ">Method</span><span class="pun">;</span></code></li><li class="L7"><code class="language-java"><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">lang</span><span class="pun">.</span><span class="pln">reflect</span><span class="pun">.</span><span class="typ">Proxy</span><span class="pun">;</span></code></li><li class="L8"><code class="language-java"><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">util</span><span class="pun">.</span><span class="typ">Map</span><span class="pun">;</span></code></li><li class="L9"><code class="language-java"></code></li><li class="L0"><code class="language-java"><span class="com">/**</span></code></li><li class="L1"><code class="language-java"><span class="com"> * @author ZHP</span></code></li><li class="L2"><code class="language-java"><span class="com"> * @since 16/12/25 17:56</span></code></li><li class="L3"><code class="language-java"><span class="com"> */</span></code></li><li class="L4"><code class="language-java"></code></li><li class="L5"><code class="language-java"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">HookManager</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code class="language-java"></code></li><li class="L7"><code class="language-java"><span class="pln">    </span><span class="lit">@SuppressWarnings</span><span class="pun">(</span><span class="str">"unchecked"</span><span class="pun">)</span></code></li><li class="L8"><code class="language-java"><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">boolean</span><span class="pln"> hookLocationManager</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code class="language-java"><span class="pln">        </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L0"><code class="language-java"><span class="pln">            </span><span class="com">// 1. 获取系统自己的Binder</span></code></li><li class="L1"><code class="language-java"><span class="pln">            </span><span class="typ">Class</span><span class="pln"> </span><span class="typ">ServiceManager</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Class</span><span class="pun">.</span><span class="pln">forName</span><span class="pun">(</span><span class="str">"android.os.ServiceManager"</span><span class="pun">);</span></code></li><li class="L2"><code class="language-java"><span class="pln">            </span><span class="typ">Method</span><span class="pln"> getService </span><span class="pun">=</span><span class="pln"> </span><span class="typ">ServiceManager</span><span class="pun">.</span><span class="pln">getDeclaredMethod</span><span class="pun">(</span><span class="str">"getService"</span><span class="pun">,</span><span class="pln"> </span><span class="typ">String</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span></code></li><li class="L3"><code class="language-java"><span class="pln">            </span><span class="typ">IBinder</span><span class="pln"> binder </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">IBinder</span><span class="pun">)</span><span class="pln"> getService</span><span class="pun">.</span><span class="pln">invoke</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Context</span><span class="pun">.</span><span class="pln">LOCATION_SERVICE</span><span class="pun">);</span></code></li><li class="L4"><code class="language-java"></code></li><li class="L5"><code class="language-java"><span class="pln">            </span><span class="com">// 2. 创建我们自己的Binder</span></code></li><li class="L6"><code class="language-java"><span class="pln">            </span><span class="typ">ClassLoader</span><span class="pln"> classLoader </span><span class="pun">=</span><span class="pln"> binder</span><span class="pun">.</span><span class="pln">getClass</span><span class="pun">().</span><span class="pln">getClassLoader</span><span class="pun">();</span></code></li><li class="L7"><code class="language-java"><span class="pln">            </span><span class="typ">Class</span><span class="pun">[]</span><span class="pln"> interfaces </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="typ">IBinder</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">};</span></code></li><li class="L8"><code class="language-java"><span class="pln">            </span><span class="typ">BinderHookHandler</span><span class="pln"> handler </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">BinderHookHandler</span><span class="pun">(</span><span class="pln">binder</span><span class="pun">);</span></code></li><li class="L9"><code class="language-java"><span class="pln">            </span><span class="typ">IBinder</span><span class="pln"> customBinder </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">IBinder</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Proxy</span><span class="pun">.</span><span class="pln">newProxyInstance</span><span class="pun">(</span><span class="pln">classLoader</span><span class="pun">,</span><span class="pln"> interfaces</span><span class="pun">,</span><span class="pln"> handler</span><span class="pun">);</span></code></li><li class="L0"><code class="language-java"></code></li><li class="L1"><code class="language-java"><span class="pln">            </span><span class="com">// 3. 获取ServiceManager中的sCache</span></code></li><li class="L2"><code class="language-java"><span class="pln">            </span><span class="typ">Field</span><span class="pln"> sCache </span><span class="pun">=</span><span class="pln"> </span><span class="typ">ServiceManager</span><span class="pun">.</span><span class="pln">getDeclaredField</span><span class="pun">(</span><span class="str">"sCache"</span><span class="pun">);</span></code></li><li class="L3"><code class="language-java"><span class="pln">            sCache</span><span class="pun">.</span><span class="pln">setAccessible</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></code></li><li class="L4"><code class="language-java"><span class="pln">            </span><span class="typ">Map</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="pln"> </span><span class="typ">IBinder</span><span class="pun">&gt;</span><span class="pln"> cache </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Map</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="pln"> </span><span class="typ">IBinder</span><span class="pun">&gt;)</span><span class="pln"> sCache</span><span class="pun">.</span><span class="pln">get</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">);</span></code></li><li class="L5"><code class="language-java"></code></li><li class="L6"><code class="language-java"><span class="pln">            </span><span class="com">// 4. 将自定义的Binder替换掉旧的系统Binder</span></code></li><li class="L7"><code class="language-java"><span class="pln">            cache</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="typ">Context</span><span class="pun">.</span><span class="pln">LOCATION_SERVICE</span><span class="pun">,</span><span class="pln"> customBinder</span><span class="pun">);</span></code></li><li class="L8"><code class="language-java"><span class="pln">            sCache</span><span class="pun">.</span><span class="pln">setAccessible</span><span class="pun">(</span><span class="kwd">false</span><span class="pun">);</span></code></li><li class="L9"><code class="language-java"><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></code></li><li class="L0"><code class="language-java"><span class="pln">        </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Exception</span><span class="pln"> e</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code class="language-java"><span class="pln">            e</span><span class="pun">.</span><span class="pln">printStackTrace</span><span class="pun">();</span></code></li><li class="L2"><code class="language-java"><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span></code></li><li class="L3"><code class="language-java"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L4"><code class="language-java"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L5"><code class="language-java"><span class="pun">}</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h2 data-anchor-id="dbah" id="5-测试">5. 测试</h2><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="7kej"><ol class="linenums"><li class="L0"><code class="language-java"><span class="kwd">package</span><span class="pln"> com</span><span class="pun">.</span><span class="pln">zhp</span><span class="pun">.</span><span class="pln">binderhook</span><span class="pun">;</span></code></li><li class="L1"><code class="language-java"></code></li><li class="L2"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="typ">Manifest</span><span class="pun">;</span></code></li><li class="L3"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">content</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">;</span></code></li><li class="L4"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">content</span><span class="pun">.</span><span class="pln">pm</span><span class="pun">.</span><span class="typ">PackageManager</span><span class="pun">;</span></code></li><li class="L5"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">location</span><span class="pun">.</span><span class="typ">Location</span><span class="pun">;</span></code></li><li class="L6"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">location</span><span class="pun">.</span><span class="typ">LocationManager</span><span class="pun">;</span></code></li><li class="L7"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">os</span><span class="pun">.</span><span class="typ">Bundle</span><span class="pun">;</span></code></li><li class="L8"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">support</span><span class="pun">.</span><span class="pln">v4</span><span class="pun">.</span><span class="pln">app</span><span class="pun">.</span><span class="typ">ActivityCompat</span><span class="pun">;</span></code></li><li class="L9"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">support</span><span class="pun">.</span><span class="pln">v7</span><span class="pun">.</span><span class="pln">app</span><span class="pun">.</span><span class="typ">AppCompatActivity</span><span class="pun">;</span></code></li><li class="L0"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">util</span><span class="pun">.</span><span class="typ">Log</span><span class="pun">;</span></code></li><li class="L1"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="typ">View</span><span class="pun">;</span></code></li><li class="L2"><code class="language-java"><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">widget</span><span class="pun">.</span><span class="typ">Toast</span><span class="pun">;</span></code></li><li class="L3"><code class="language-java"></code></li><li class="L4"><code class="language-java"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">MainActivity</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">AppCompatActivity</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code class="language-java"></code></li><li class="L6"><code class="language-java"><span class="pln">    </span><span class="lit">@Override</span></code></li><li class="L7"><code class="language-java"><span class="pln">    </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onCreate</span><span class="pun">(</span><span class="typ">Bundle</span><span class="pln"> savedInstanceState</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L8"><code class="language-java"><span class="pln">        </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onCreate</span><span class="pun">(</span><span class="pln">savedInstanceState</span><span class="pun">);</span></code></li><li class="L9"><code class="language-java"><span class="pln">        setContentView</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">layout</span><span class="pun">.</span><span class="pln">activity_main</span><span class="pun">);</span></code></li><li class="L0"><code class="language-java"></code></li><li class="L1"><code class="language-java"><span class="pln">        </span><span class="com">// Hook</span></code></li><li class="L2"><code class="language-java"><span class="pln">        </span><span class="typ">HookManager</span><span class="pun">.</span><span class="pln">hookLocationManager</span><span class="pun">();</span></code></li><li class="L3"><code class="language-java"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L4"><code class="language-java"></code></li><li class="L5"><code class="language-java"><span class="pln">    </span><span class="com">/**</span></code></li><li class="L6"><code class="language-java"><span class="com">     * 请求定位信息</span></code></li><li class="L7"><code class="language-java"><span class="com">     */</span></code></li><li class="L8"><code class="language-java"><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> requestLocation</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code class="language-java"><span class="pln">        </span><span class="com">// 定位权限检测</span></code></li><li class="L0"><code class="language-java"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">ActivityCompat</span><span class="pun">.</span><span class="pln">checkSelfPermission</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Manifest</span><span class="pun">.</span><span class="pln">permission</span><span class="pun">.</span><span class="pln">ACCESS_FINE_LOCATION</span><span class="pun">)</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="typ">PackageManager</span><span class="pun">.</span><span class="pln">PERMISSION_GRANTED </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="typ">ActivityCompat</span><span class="pun">.</span><span class="pln">checkSelfPermission</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Manifest</span><span class="pun">.</span><span class="pln">permission</span><span class="pun">.</span><span class="pln">ACCESS_COARSE_LOCATION</span><span class="pun">)</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="typ">PackageManager</span><span class="pun">.</span><span class="pln">PERMISSION_GRANTED</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code class="language-java"><span class="pln">            </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">i</span><span class="pun">(</span><span class="str">"郑海鹏"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"没有定位权限"</span><span class="pun">);</span></code></li><li class="L2"><code class="language-java"><span class="pln">            </span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">makeText</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln"> </span><span class="str">"没有定位权限"</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">LENGTH_SHORT</span><span class="pun">).</span><span class="pln">show</span><span class="pun">();</span></code></li><li class="L3"><code class="language-java"><span class="pln">            </span><span class="kwd">return</span><span class="pun">;</span></code></li><li class="L4"><code class="language-java"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L5"><code class="language-java"></code></li><li class="L6"><code class="language-java"><span class="pln">        </span><span class="com">// 获取位置并显示</span></code></li><li class="L7"><code class="language-java"><span class="pln">        </span><span class="typ">LocationManager</span><span class="pln"> locationManager </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">LocationManager</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">getSystemService</span><span class="pun">(</span><span class="typ">Context</span><span class="pun">.</span><span class="pln">LOCATION_SERVICE</span><span class="pun">);</span></code></li><li class="L8"><code class="language-java"><span class="pln">        </span><span class="typ">Location</span><span class="pln"> location </span><span class="pun">=</span><span class="pln"> locationManager</span><span class="pun">.</span><span class="pln">getLastKnownLocation</span><span class="pun">(</span><span class="typ">LocationManager</span><span class="pun">.</span><span class="pln">GPS_PROVIDER</span><span class="pun">);</span></code></li><li class="L9"><code class="language-java"><span class="pln">        </span><span class="typ">String</span><span class="pln"> message </span><span class="pun">=</span><span class="pln"> </span><span class="str">"("</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> location</span><span class="pun">.</span><span class="pln">getLongitude</span><span class="pun">()</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">", "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> location</span><span class="pun">.</span><span class="pln">getLatitude</span><span class="pun">()</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">")"</span><span class="pun">;</span></code></li><li class="L0"><code class="language-java"><span class="pln">        </span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">makeText</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln"> message</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">LENGTH_LONG</span><span class="pun">).</span><span class="pln">show</span><span class="pun">();</span></code></li><li class="L1"><code class="language-java"><span class="pln">        </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">i</span><span class="pun">(</span><span class="str">"郑海鹏"</span><span class="pun">,</span><span class="pln"> message</span><span class="pun">);</span></code></li><li class="L2"><code class="language-java"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L3"><code class="language-java"></code></li><li class="L4"><code class="language-java"><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onClick</span><span class="pun">(</span><span class="typ">View</span><span class="pln"> view</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code class="language-java"><span class="pln">        </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">requestLocation</span><span class="pun">();</span></code></li><li class="L6"><code class="language-java"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L7"><code class="language-java"><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="7c3u">当onClick被调用的时候，Toast和Log都会显示天安门的坐标(116.23, 39.54)。证明Hook成功！</p><p data-anchor-id="llt9">你甚至可以用Binder Hook的方式Hook掉 <strong>ActivityManager</strong>。</p><hr></div>
</body>
</html>